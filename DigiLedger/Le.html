<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Ledger</title>
    <!-- External libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Custom CSS -->
    <style>
        body {
            padding-bottom: 80px;
            background-color: #f8f9fa;
        }
        .customer-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .customer-pic {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            background-color: #e9ecef;
        }
        .customer-balance {
            font-weight: bold;
        }
        #add-customer-form-section {
            border-top: 1px solid #dee2e6;
            margin-top: 2rem;
            padding-top: 1.5rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .fab-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
        }
        .fab-popup-menu {
            display: none;
            flex-direction: column;
            margin-bottom: 10px;
        }
        .fab-menu-item {
            width: 48px;
            height: 48px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #fab-main {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #0d6efd;
            color: white;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        .text-danger { color: #dc3545 !important; }
        .text-success { color: #198754 !important; }
        .card { margin-bottom: 20px; }
        #transaction-list .card { margin-bottom: 10px; }
        #search-bar { max-width: 500px; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Digital Ledger</a>
            <div class="ms-auto d-flex">
                <input class="form-control me-2" type="search" id="search-bar" placeholder="Search by Name, CNIC, Account No...">
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mt-4" id="main-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h4">All Customers</h2>
            <button id="export-data-btn" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-download me-1"></i> Export Data
            </button>
        </div>
        <div class="list-group" id="records-container">
            <!-- Dynamically populated -->
        </div>
    </div>

    <!-- Customer Detail View -->
    <div id="customer-detail-view" class="container mt-4" style="display: none;">
        <!-- Dynamically populated -->
    </div>

    <!-- Transaction Form -->
    <div id="transaction-form-section" class="container mt-4" style="display: none;">
        <h2 class="h4 mb-3">Add Transaction</h2>
        <form id="transaction-form">
            <input type="hidden" id="transaction-customer-id">
            <div class="mb-3">
                <label for="transaction-amount" class="form-label">Amount</label>
                <input type="number" class="form-control" id="transaction-amount" step="0.01" required>
            </div>
            <div class="mb-3">
                <label for="transaction-date" class="form-label">Date</label>
                <input type="date" class="form-control" id="transaction-date" required>
            </div>
            <div class="mb-3">
                <label for="receipt-picture" class="form-label">Receipt Picture</label>
                <input type="file" class="form-control" id="receipt-picture" accept="image/*">
            </div>
            <button type="submit" class="btn btn-primary me-2">Save Transaction</button>
            <button type="button" id="cancel-transaction" class="btn btn-secondary">Cancel</button>
        </form>
    </div>

    <!-- Add Customer Form -->
    <div class="container mt-4" id="add-customer-form-section" style="display: none;">
        <h2 class="h4 mb-3">Add New Customer</h2>
        <form id="ledger-form">
            <!-- Customer Info -->
            <div class="card mb-4">
                <div class="card-header"><h5>Customer Information</h5></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="customer-name" class="form-label">Full Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="customer-name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="account-no" class="form-label">Account No.</label>
                            <input type="text" class="form-control" id="account-no" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="father-name" class="form-label">Father's Name</label>
                            <input type="text" class="form-control" id="father-name">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cnic" class="form-label">CNIC <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="cnic" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="mobile-number" class="form-label">Mobile Number</label>
                            <input type="tel" class="form-control" id="mobile-number">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="customer-picture" class="form-label">Profile Picture</label>
                            <input type="file" class="form-control" id="customer-picture" accept="image/*">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Purchase & Installment -->
            <div class="card mb-4">
                <div class="card-header"><h5>Purchase & Installment</h5></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="total-amount" class="form-label">Total Amount</label>
                            <input type="number" class="form-control" id="total-amount" step="0.01">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="advance-payment" class="form-label">Advance Payment</label>
                            <input type="number" class="form-control" id="advance-payment" step="0.01">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="monthly-installment" class="form-label">Monthly Installment</label>
                            <input type="number" class="form-control" id="monthly-installment" step="0.01">
                        </div>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">Save Record</button>
        </form>
    </div>

    <!-- FAB Menu -->
    <div class="fab-container">
        <div class="fab-popup-menu">
            <button id="fab-add-customer" class="fab-menu-item btn btn-primary rounded-circle shadow" title="Add Customer">
                <i class="fas fa-user-plus"></i>
            </button>
            <button id="fab-import" class="fab-menu-item btn btn-info rounded-circle shadow" title="Import Data">
                <i class="fas fa-upload"></i>
            </button>
        </div>
        <button id="fab-main" class="btn rounded-circle shadow">
            <i class="fas fa-bars"></i>
        </button>
    </div>
    <input type="file" id="import-file-input" accept=".json" style="display: none;">

    <!-- JavaScript -->
    <script>
        // --- State ---
        let db;
        let allRecords = [];
        const DB_NAME = 'DigitalLedgerDB';
        const STORE_NAME = 'customers';
        const TX_STORE_NAME = 'transactions';
        const DEFAULT_PIC = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23adb5bd'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E";

        // --- DOM Elements ---
        const recordsContainer = document.getElementById('records-container');
        const searchBar = document.getElementById('search-bar');
        const accountNoInput = document.getElementById('account-no');
        const ledgerForm = document.getElementById('ledger-form');
        const transactionForm = document.getElementById('transaction-form');
        const fabMain = document.getElementById('fab-main');
        const fabPopupMenu = document.querySelector('.fab-popup-menu');
        const fabAddCustomer = document.getElementById('fab-add-customer');
        const fabImport = document.getElementById('fab-import');
        const importFileInput = document.getElementById('import-file-input');
        const exportDataBtn = document.getElementById('export-data-btn');

        // --- Init DB ---
        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains(TX_STORE_NAME)) {
                        const txStore = db.createObjectStore(TX_STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        txStore.createIndex('customerId', 'customerId', { unique: false });
                    }
                };
                request.onsuccess = () => { db = request.result; resolve(); };
                request.onerror = (e) => reject(e.target.error);
            });
        };

        // --- Generate Account ID ---
        const generateAccountId = () => {
            const year = new Date().getFullYear().toString().slice(-2);
            const maxSerial = allRecords.reduce((max, record) => {
                if (record.accountNo?.startsWith(year + '-')) {
                    const serial = parseInt(record.accountNo.split('-')[1]);
                    return serial > max ? serial : max;
                }
                return max;
            }, 0);
            return `${year}-${String(maxSerial + 1).padStart(2, '0')}`;
        };

        // --- Load Records ---
        const loadRecords = async () => {
            if (!db) await initDB();
            return new Promise((resolve) => {
                const tx = db.transaction([STORE_NAME, TX_STORE_NAME], 'readonly');
                const customersStore = tx.objectStore(STORE_NAME);
                const transactionsStore = tx.objectStore(TX_STORE_NAME);

                customersStore.getAll().onsuccess = (e) => {
                    allRecords = e.target.result.sort((a, b) => a.accountNo.localeCompare(b.accountNo));
                    transactionsStore.getAll().onsuccess = (e) => {
                        const transactions = e.target.result;
                        allRecords.forEach(customer => {
                            customer.totalPaid = transactions
                                .filter(t => t.customerId === customer.id)
                                .reduce((sum, t) => sum + t.amount, 0);
                        });
                        resolve();
                    };
                };
            });
        };

        // --- Display Records ---
        const displayRecords = (records = allRecords) => {
            recordsContainer.innerHTML = records.length
                ? records.map(record => {
                    const balance = (record.totalAmount || 0) - (record.advancePayment || 0) - (record.totalPaid || 0);
                    const balanceClass = balance > 0 ? 'text-danger' : 'text-success';
                    return `
                        <div class="customer-list-item" data-id="${record.id}">
                            <div class="d-flex align-items-center">
                                <img src="${record.customerPicture || DEFAULT_PIC}" class="customer-pic">
                                <div>
                                    <h6 class="mb-0">${record.customerName}</h6>
                                    <small class="text-muted">${record.cnic}</small><br>
                                    <small class="text-muted">A/C: ${record.accountNo}</small>
                                </div>
                            </div>
                            <div class="customer-balance ${balanceClass}">
                                Rs ${balance.toLocaleString()}
                            </div>
                        </div>
                    `;
                }).join('')
                : '<p class="text-center text-muted mt-4">No customers found.</p>';
        };

        // --- Show Customer Details ---
        const showCustomerDetails = (recordId) => {
            const record = allRecords.find(r => r.id === recordId);
            if (!record) return;

            document.getElementById('main-content').style.display = 'none';
            document.getElementById('customer-detail-view').style.display = 'block';
            document.getElementById('customer-detail-view').innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button id="back-to-list" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Back
                    </button>
                    <button id="edit-customer" class="btn btn-sm btn-outline-primary" data-id="${record.id}">
                        <i class="fas fa-pencil-alt me-1"></i> Edit
                    </button>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h5>${record.customerName}</h5>
                        <p class="mb-0">A/C: ${record.accountNo}</p>
                    </div>
                    <div class="card-body">
                        <p><strong>CNIC:</strong> ${record.cnic}</p>
                        <p><strong>Mobile:</strong> ${record.mobileNumber || 'N/A'}</p>
                        <p><strong>Total Amount:</strong> ${(record.totalAmount || 0).toLocaleString()}</p>
                        <p><strong>Advance:</strong> ${(record.advancePayment || 0).toLocaleString()}</p>
                        <p><strong>Total Paid:</strong> ${(record.totalPaid || 0).toLocaleString()}</p>
                        <h5 class="mt-3">
                            <strong>Remaining:</strong>
                            <span class="${(record.totalAmount - record.advancePayment - record.totalPaid) > 0 ? 'text-danger' : 'text-success'}">
                                ${((record.totalAmount || 0) - (record.advancePayment || 0) - (record.totalPaid || 0)).toLocaleString()}
                            </span>
                        </h5>
                    </div>
                </div>
                <div class="mt-4">
                    <h5>Transactions</h5>
                    <button id="add-transaction" class="btn btn-primary btn-sm mb-3" data-id="${record.id}">
                        <i class="fas fa-plus me-1"></i> Add Transaction
                    </button>
                    <div id="transaction-list"></div>
                </div>
            `;

            // Load transactions
            const txList = document.getElementById('transaction-list');
            const tx = db.transaction([TX_STORE_NAME], 'readonly');
            tx.objectStore(TX_STORE_NAME).index('customerId').getAll(record.id).onsuccess = (e) => {
                txList.innerHTML = e.target.result.length
                    ? e.target.result.map(t => `
                        <div class="card">
                            <div class="card-body">
                                <p><strong>Amount:</strong> ${t.amount.toLocaleString()}</p>
                                <p><strong>Date:</strong> ${t.date}</p>
                                ${t.receipt ? `<a href="${t.receipt}" target="_blank">View Receipt</a>` : ''}
                            </div>
                        </div>
                    `).join('')
                    : '<p>No transactions yet.</p>';
            };

            // Event listeners
            document.getElementById('back-to-list').onclick = () => {
                document.getElementById('main-content').style.display = 'block';
                document.getElementById('customer-detail-view').style.display = 'none';
            };
            document.getElementById('edit-customer').onclick = () => handleEdit(recordId);
            document.getElementById('add-transaction').onclick = () => showTransactionForm(recordId);
        };

        // --- Show Transaction Form ---
        const showTransactionForm = (customerId) => {
            document.getElementById('customer-detail-view').style.display = 'none';
            document.getElementById('transaction-form-section').style.display = 'block';
            document.getElementById('transaction-customer-id').value = customerId;
        };

        // --- Handle Edit ---
        const handleEdit = (recordId) => {
            const record = allRecords.find(r => r.id === recordId);
            if (!record) return;

            document.getElementById('customer-name').value = record.customerName;
            document.getElementById('account-no').value = record.accountNo;
            document.getElementById('father-name').value = record.fatherName;
            document.getElementById('cnic').value = record.cnic;
            document.getElementById('mobile-number').value = record.mobileNumber;
            document.getElementById('total-amount').value = record.totalAmount || 0;
            document.getElementById('advance-payment').value = record.advancePayment || 0;
            document.getElementById('monthly-installment').value = record.monthlyInstallment || 0;

            ledgerForm.dataset.editId = recordId;
            document.getElementById('add-customer-form-section').style.display = 'block';
            window.scrollTo(0, 0);
        };

        // --- File to Base64 ---
        const fileToBase64 = (file) => {
            return new Promise((resolve) => {
                if (!file) resolve(null);
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });
        };

        // --- Save Record ---
        const saveRecord = async (record) => {
            const tx = db.transaction([STORE_NAME], 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            const request = record.id ? store.put(record) : store.add(record);
            await new Promise((resolve, reject) => {
                request.onsuccess = resolve;
                request.onerror = () => reject(request.error);
            });
            await loadRecords();
            displayRecords();
        };

        // --- Save Transaction ---
        const saveTransaction = async (transaction) => {
            const tx = db.transaction([TX_STORE_NAME], 'readwrite');
            await tx.objectStore(TX_STORE_NAME).add(transaction);
            await loadRecords();
        };

        // --- Export Data ---
        const exportData = () => {
            const tx = db.transaction([STORE_NAME, TX_STORE_NAME], 'readonly');
            tx.objectStore(STORE_NAME).getAll().onsuccess = (e) => {
                const customers = e.target.result;
                tx.objectStore(TX_STORE_NAME).getAll().onsuccess = (e) => {
                    const transactions = e.target.result;
                    const data = JSON.stringify({ customers, transactions }, null, 2);
                    const blob = new Blob([data], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ledger-backup-${new Date().toISOString().slice(0, 10)}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                };
            };
        };

        // --- Import Data ---
        const importData = (file) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const { customers, transactions } = JSON.parse(e.target.result);
                    const tx = db.transaction([STORE_NAME, TX_STORE_NAME], 'readwrite');
                    tx.objectStore(STORE_NAME).clear();
                    tx.objectStore(TX_STORE_NAME).clear();
                    customers.forEach(c => tx.objectStore(STORE_NAME).add(c));
                    transactions.forEach(t => tx.objectStore(TX_STORE_NAME).add(t));
                    await new Promise((resolve) => (tx.oncomplete = resolve));
                    await loadRecords();
                    displayRecords();
                    alert('Data imported successfully!');
                } catch (error) {
                    alert('Error importing data: ' + error.message);
                }
            };
            reader.readAsText(file);
        };

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', async () => {
            await initDB();
            await loadRecords();
            displayRecords();
            accountNoInput.value = generateAccountId();

            // Search
            searchBar.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                displayRecords(allRecords.filter(r =>
                    r.customerName.toLowerCase().includes(term) ||
                    r.cnic.includes(term) ||
                    r.accountNo.includes(term)
                ));
            });

            // FAB Menu
            fabMain.addEventListener('click', () => {
                fabPopupMenu.style.display = fabPopupMenu.style.display === 'flex' ? 'none' : 'flex';
            });
            fabAddCustomer.addEventListener('click', () => {
                document.getElementById('add-customer-form-section').style.display = 'block';
                window.scrollTo(0, 0);
                fabPopupMenu.style.display = 'none';
            });
            fabImport.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) importData(e.target.files[0]);
            });
            exportDataBtn.addEventListener('click', exportData);

            // Records click
            recordsContainer.addEventListener('click', (e) => {
                const item = e.target.closest('.customer-list-item');
                if (item) showCustomerDetails(parseInt(item.dataset.id));
            });

            // Ledger Form
            ledgerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const record = {
                    id: ledgerForm.dataset.editId ? parseInt(ledgerForm.dataset.editId) : undefined,
                    customerName: document.getElementById('customer-name').value,
                    accountNo: document.getElementById('account-no').value,
                    fatherName: document.getElementById('father-name').value,
                    cnic: document.getElementById('cnic').value,
                    mobileNumber: document.getElementById('mobile-number').value,
                    totalAmount: parseFloat(document.getElementById('total-amount').value) || 0,
                    advancePayment: parseFloat(document.getElementById('advance-payment').value) || 0,
                    monthlyInstallment: parseFloat(document.getElementById('monthly-installment').value) || 0,
                    customerPicture: await fileToBase64(document.getElementById('customer-picture').files[0]),
                };
                await saveRecord(record);
                ledgerForm.reset();
                accountNoInput.value = generateAccountId();
                document.getElementById('add-customer-form-section').style.display = 'none';
                delete ledgerForm.dataset.editId;
            });

            // Transaction Form
            transactionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const transaction = {
                    customerId: parseInt(document.getElementById('transaction-customer-id').value),
                    amount: parseFloat(document.getElementById('transaction-amount').value),
                    date: document.getElementById('transaction-date').value,
                    receipt: await fileToBase64(document.getElementById('receipt-picture').files[0]),
                };
                await saveTransaction(transaction);
                transactionForm.reset();
                document.getElementById('transaction-form-section').style.display = 'none';
                showCustomerDetails(transaction.customerId);
            });

            // Cancel Transaction
            document.getElementById('cancel-transaction').addEventListener('click', () => {
                transactionForm.reset();
                document.getElementById('transaction-form-section').style.display = 'none';
                showCustomerDetails(parseInt(document.getElementById('transaction-customer-id').value));
            });
        });
    </script>
</body>
</html>
