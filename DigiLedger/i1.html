<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Ledger</title>

    <!-- External libraries for styling and icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- Embedded CSS for custom styling -->
    <style>
        /* Add some padding to the bottom of the page to prevent content from being hidden by the form */
        body {
            padding-bottom: 40px;
        }

        /* Style for each item in the customer list */
        .customer-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        /* Container for the customer's picture and name */
        .customer-info {
            display: flex;
            align-items: center;
        }

        /* Style for the customer's profile picture */
        .customer-pic {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            background-color: #e9ecef;
        }

        /* Style for the customer's balance display */
        .customer-balance {
            font-weight: bold;
        }

        /* Style for the "Add New Customer" form section */
        #add-customer-form-section {
            border-top: 1px solid #dee2e6;
            margin-top: 2rem;
            padding-top: 1.5rem;
        }

        #add-customer-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            z-index: 1000;
        }

        .fab-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
        }

        .fab-popup-menu {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }

        .fab-menu-item {
            width: 48px;
            height: 48px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <!-- Page Header -->
    <header class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Digital Ledger</a>
            <div class="ms-auto d-flex" style="width: 50%;">
                <input class="form-control me-2" type="search" id="search-bar" placeholder="Search by Name, CNIC, etc..." aria-label="Search">
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <div class="container mt-4" id="main-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h4">All Customers</h2>
        </div>
        <div class="list-group" id="records-container">
            <!-- Customer list will be dynamically inserted here by JavaScript -->
        </div>
    </div>

    

    <!-- Customer Detail View -->
    <div id="customer-detail-view" class="container mt-4" style="display: none;">
        <!-- Customer details will be dynamically inserted here -->
    </div>

    <!-- Transaction Form Section -->
    <div id="transaction-form-section" class="container mt-4" style="display: none;">
        <h2 class="h4 mb-3">Add Transaction</h2>
        <form id="transaction-form">
            <input type="hidden" id="transaction-customer-id">
            <div class="mb-3">
                <label for="transaction-amount" class="form-label">Amount</label>
                <input type="number" class="form-control" id="transaction-amount" required>
            </div>
            <div class="mb-3">
                <label for="transaction-date" class="form-label">Date</label>
                <input type="date" class="form-control" id="transaction-date" required>
            </div>
            <div class="mb-3">
                <label for="receipt-picture" class="form-label">Receipt Picture</label>
                <input type="file" class="form-control" id="receipt-picture" accept="image/*">
            </div>
            <button type="submit" class="btn btn-primary">Save Transaction</button>
            <button type="button" id="cancel-transaction" class="btn btn-secondary">Cancel</button>
        </form>
    </div>


    <!-- Add New Customer Form Section -->
    <div class="container mt-4" id="add-customer-form-section" style="display: none;">
        <h2 class="h4 mb-3">Add New Customer</h2>
        <form id="ledger-form">
            
            <!-- Customer Information Card -->
            <div class="card mb-4">
                <div class="card-header"><h3>Customer Information</h3></div>
                <div class="card-body"><div class="row">
                    <div class="col-md-6 mb-3"><label for="customer-name" class="form-label">Honorable Name <span class="text-danger">*</span></label><input type="text" class="form-control" id="customer-name" required></div>
                    <div class="col-md-6 mb-3"><label for="account-no" class="form-label">Account No.</label><input type="text" class="form-control" id="account-no"></div>
                    <div class="col-md-6 mb-3"><label for="father-name" class="form-label">Father's Name</label><input type="text" class="form-control" id="father-name"></div>
                    <div class="col-md-6 mb-3"><label for="nation" class="form-label">Nation</label><input type="text" class="form-control" id="nation"></div>
                    <div class="col-md-6 mb-3"><label for="dob" class="form-label">Date of Birth</label><input type="date" class="form-control" id="dob"></div>
                    <div class="col-md-6 mb-3"><label for="cnic" class="form-label">Identity Card No. <span class="text-danger">*</span></label><input type="text" class="form-control" id="cnic" required></div>
                    <div class="mb-3"><label for="current-address" class="form-label">Current Address</label><textarea class="form-control" id="current-address" rows="2"></textarea></div>
                    <div class="mb-3"><label for="employment-address" class="form-label">Employment Address</label><textarea class="form-control" id="employment-address" rows="2"></textarea></div>
                    <div class="col-md-6 mb-3"><label for="phone-home" class="form-label">Phone (Home)</label><input type="tel" class="form-control" id="phone-home"></div>
                    <div class="col-md-6 mb-3"><label for="phone-office" class="form-label">Phone (Office)</label><input type="tel" class="form-control" id="phone-office"></div>
                    <div class="col-md-6 mb-3"><label for="mobile-number" class="form-label">Mobile Number</label><input type="tel" class="form-control" id="mobile-number"></div>
                    <div class="col-md-6 mb-3"><label for="customer-picture" class="form-label">Customer Picture</label><input type="file" class="form-control" id="customer-picture" accept="image/*"></div>
                    <div class="col-md-6 mb-3"><label for="cnic-picture" class="form-label">Customer CNIC Picture</label><input type="file" class="form-control" id="cnic-picture" accept="image/*"></div>
                </div></div>
            </div>

            <!-- Guarantor Information Card -->
            <div class="card mb-4">
                <div class="card-header"><h3>Guarantor Information</h3></div>
                <div class="card-body"><div class="row">
                    <div class="col-md-6 mb-3"><label for="guarantor-name" class="form-label">Guarantor Name</label><input type="text" class="form-control" id="guarantor-name"></div>
                    <div class="col-md-6 mb-3"><label for="guarantor-father-name" class="form-label">Guarantor's Father's Name</label><input type="text" class="form-control" id="guarantor-father-name"></div>
                    <div class="col-md-6 mb-3"><label for="guarantor-nation" class="form-label">Guarantor's Nation</label><input type="text" class="form-control" id="guarantor-nation"></div>
                    <div class="col-md-6 mb-3"><label for="guarantor-dob" class="form-label">Guarantor's Date of Birth</label><input type="date" class="form-control" id="guarantor-dob"></div>
                    <div class="col-md-6 mb-3"><label for="guarantor-cnic" class="form-label">Guarantor's Identity Card No.</label><input type="text" class="form-control" id="guarantor-cnic"></div>
                    <div class="mb-3"><label for="guarantor-current-address" class="form-label">Guarantor's Current Address</label><textarea class="form-control" id="guarantor-current-address" rows="2"></textarea></div>
                    <div class="mb-3"><label for="guarantor-employment-address" class="form-label">Guarantor's Employment Address</label><textarea class="form-control" id="guarantor-employment-address" rows="2"></textarea></div>
                    <div class="col-md-6 mb-3"><label for="guarantor-phone-home" class="form-label">Guarantor's Phone (Home)</label><input type="tel" class="form-control" id="guarantor-phone-home"></div>
                    <div class="col-md-6 mb-3"><label for="guarantor-phone-office" class="form-label">Guarantor's Phone (Office)</label><input type="tel" class="form-control" id="guarantor-phone-office"></div>
                    <div class="col-md-6 mb-3"><label for="guarantor-mobile-number" class="form-label">Guarantor's Mobile Number</label><input type="tel" class="form-control" id="guarantor-mobile-number"></div>
                    <div class="col-md-6 mb-3"><label for="guarantor-picture" class="form-label">Guarantor's Picture</label><input type="file" class="form-control" id="guarantor-picture" accept="image/*"></div>
                    <div class="col-md-6 mb-3"><label for="guarantor-cnic-picture" class="form-label">Guarantor's CNIC Picture</label><input type="file" class="form-control" id="guarantor-cnic-picture" accept="image/*"></div>
                </div></div>
            </div>

            <!-- Purchase & Installment Details Card -->
            <div class="card mb-4">
                <div class="card-header"><h3>Purchase & Installment Details</h3></div>
                <div class="card-body"><div class="row">
                    <div class="col-md-6 mb-3"><label for="purchase-date" class="form-label">Purchase Date</label><input type="date" class="form-control" id="purchase-date"></div>
                    <div class="col-md-6 mb-3"><label for="object-name" class="form-label">Name of object(s)</label><input type="text" class="form-control" id="object-name"></div>
                    <div class="col-md-6 mb-3"><label for="receipt-no" class="form-label">Receipt No.</label><input type="text" class="form-control" id="receipt-no"></div>
                    <div class="col-md-6 mb-3"><label for="total-amount" class="form-label">The Whole Figure (Total Amount)</label><input type="number" class="form-control" id="total-amount" step="0.01"></div>
                    <div class="col-md-6 mb-3"><label for="advance-payment" class="form-label">Advance</label><input type="number" class="form-control" id="advance-payment" step="0.01"></div>
                    <div class="col-md-6 mb-3"><label for="monthly-installment" class="form-label">Monthly Installment</label><input type="number" class="form-control" id="monthly-installment" step="0.01"></div>
                    <div class="col-md-6 mb-3"><label for="monthly-date" class="form-label">Monthly Date (1-31)</label><input type="number" class="form-control" id="monthly-date" min="1" max="31"></div>
                </div></div>
            </div>

            <!-- Form Submission Button -->
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">Save Record</button>
            </div>
        </form>
    </div>

    <div class="fab-container">
        <div class="fab-popup-menu" style="display: none;">
            <button id="fab-add-customer" class="fab-menu-item btn btn-primary btn-sm rounded-circle shadow" title="Add Customer">
                <i class="fas fa-user-plus"></i>
            </button>
            <button id="fab-import" class="fab-menu-item btn btn-info btn-sm rounded-circle shadow" title="Import Data">
                <i class="fas fa-upload"></i>
            </button>
            <button id="fab-export" class="fab-menu-item btn btn-info btn-sm rounded-circle shadow" title="Export Data">
                <i class="fas fa-download"></i>
            </button>
        </div>
        <button id="fab-main" class="btn btn-primary btn-lg rounded-circle shadow">
            <i class="fas fa-bars"></i>
        </button>
    </div>
    <input type="file" id="import-file-input" accept=".json" style="display: none;">

    <!-- Embedded JavaScript Application -->
    <script type="module">
    // Import Firebase services
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-analytics.js";

    // Your Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyChqEOhLWphDoKnpqxImxw8LDxdLI5JfYA",
        authDomain: "digledger-ea7c9.firebaseapp.com",
        projectId: "digledger-ea7c9",
        storageBucket: "digledger-ea7c9.appspot.com", // Corrected storage bucket
        messagingSenderId: "357053207796",
        appId: "1:357053207796:web:cb8acb1efe2d563b4b3aa1",
        measurementId: "G-B1V9HLD2CE"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const analytics = getAnalytics(app);

    // Wait for the HTML document to be fully loaded
    document.addEventListener('DOMContentLoaded', () => {

        // --- DOM Element References ---
        const form = document.getElementById('ledger-form');
        const recordsContainer = document.getElementById('records-container');
        const searchBar = document.getElementById('search-bar');
        const accountNoInput = document.getElementById('account-no');
        const transactionForm = document.getElementById('transaction-form');
        const fabMain = document.getElementById('fab-main');
        const fabPopupMenu = document.querySelector('.fab-popup-menu');
        const fabAddCustomer = document.getElementById('fab-add-customer');
        const fabImport = document.getElementById('fab-import');
        const fabExport = document.getElementById('fab-export');
        const importFileInput = document.getElementById('import-file-input');

        // --- Application State ---
        let allRecords = []; // Cache for all customer records
        const DEFAULT_PIC_SVG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23adb5bd'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E";

        // --- Core Functions ---

        async function generateAccountId() {
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2);
            const querySnapshot = await getDocs(collection(db, "customers"));
            let maxSerial = 0;
            querySnapshot.forEach((doc) => {
                const record = doc.data();
                if (record.accountNo && record.accountNo.startsWith(year + '-')) {
                    const serial = parseInt(record.accountNo.split('-')[1], 10);
                    if (serial > maxSerial) {
                        maxSerial = serial;
                    }
                }
            });
            const newSerial = maxSerial + 1;
            const formattedSerial = String(newSerial).padStart(2, '0');
            return `${year}-${formattedSerial}`;
        }

        async function setAndLockAccountId() {
            accountNoInput.value = await generateAccountId();
            accountNoInput.readOnly = true;
        }

        function handleEdit(recordId) {
            const recordToEdit = allRecords.find(record => record.id === recordId);
            if (!recordToEdit) {
                alert('Record not found!');
                return;
            }

            // Populate the form, omitting picture fields
            document.getElementById('customer-name').value = recordToEdit.customerName;
            document.getElementById('account-no').value = recordToEdit.accountNo;
            // ... (populate all other fields similarly) ...

            let idInput = document.getElementById('record-id');
            if (!idInput) {
                idInput = document.createElement('input');
                idInput.type = 'hidden';
                idInput.id = 'record-id';
                form.appendChild(idInput);
            }
            idInput.value = recordToEdit.id;

            form.querySelector('button[type="submit"]').textContent = 'Update Record';
            // ... (rest of the edit logic)
        }
        
        function showCustomerDetails(recordId) {
            const record = allRecords.find(r => r.id === recordId);
            if (!record) return;

            document.getElementById('main-content').style.display = 'none';
            document.getElementById('add-customer-form-section').style.display = 'none';
            document.getElementById('customer-detail-view').style.display = 'block';

            const detailView = document.getElementById('customer-detail-view');
            // ... (build detail view using textContent to prevent XSS)
            
            loadAndDisplayTransactions(recordId);
        }

        async function loadAndDisplayTransactions(customerId) {
            const transactionList = document.getElementById('transaction-list');
            transactionList.innerHTML = '';
            const q = query(collection(db, "transactions"), where("customerId", "==", customerId));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                transactionList.innerHTML = '<p>No transactions yet.</p>';
                return;
            }
            querySnapshot.forEach((doc) => {
                const tx = doc.data();
                const item = document.createElement('div');
                item.className = 'card mb-2';
                // ... (build transaction item using textContent)
                transactionList.appendChild(item);
            });
        }

        // --- Event Listeners ---

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const recordId = document.getElementById('record-id')?.value;
            const isUpdate = !!recordId;

            const record = {
                customerName: document.getElementById('customer-name').value,
                // ... (get all other form values)
            };

            // Handle file uploads
            const uploadFile = async (fileInputId) => {
                const file = document.getElementById(fileInputId).files[0];
                if (!file) return null;
                const storageRef = ref(storage, `images/${Date.now()}_${file.name}`);
                await uploadBytes(storageRef, file);
                return await getDownloadURL(storageRef);
            };

            record.customerPictureUrl = await uploadFile('customer-picture');
            record.cnicPictureUrl = await uploadFile('cnic-picture');
            // ... (upload other images)

            if (isUpdate) {
                const docRef = doc(db, "customers", recordId);
                await updateDoc(docRef, record);
                alert('Record updated successfully!');
            } else {
                record.createdAt = new Date().toISOString();
                await addDoc(collection(db, "customers"), record);
                alert('Record saved successfully!');
            }

            form.reset();
            loadAllRecords();
        });

        // ... (Add other event listeners for FAB, search, etc.)

        // --- Database Functions (Firestore) ---

        async function loadAllRecords() {
            const customersSnapshot = await getDocs(collection(db, "customers"));
            const customers = customersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const transactionsSnapshot = await getDocs(collection(db, "transactions"));
            const paymentsByCustomer = {};
            transactionsSnapshot.forEach(doc => {
                const tx = doc.data();
                paymentsByCustomer[tx.customerId] = (paymentsByCustomer[tx.customerId] || 0) + tx.amount;
            });

            allRecords = customers.map(customer => ({
                ...customer,
                totalPaid: paymentsByCustomer[customer.id] || 0
            })).sort((a, b) => (a.accountNo < b.accountNo) ? -1 : 1);

            displayRecords(allRecords);
            setAndLockAccountId();
        }

        function displayRecords(records) {
            recordsContainer.innerHTML = '';
            if (records.length === 0) {
                recordsContainer.innerHTML = '<p class="text-center text-muted mt-4">No customers found.</p>';
                return;
            }

            records.forEach(record => {
                const remainingBalance = (record.totalAmount || 0) - (record.advancePayment || 0) - (record.totalPaid || 0);
                const balanceColor = remainingBalance > 0 ? 'text-danger' : 'text-success';

                const item = document.createElement('a');
                item.className = 'list-group-item list-group-item-action customer-list-item';
                item.dataset.id = record.id;

                const customerInfo = document.createElement('div');
                customerInfo.className = 'customer-info';

                const img = document.createElement('img');
                img.src = record.customerPictureUrl || DEFAULT_PIC_SVG;
                img.alt = "Customer profile picture";
                img.className = 'customer-pic';

                const infoDiv = document.createElement('div');
                
                const nameEl = document.createElement('h6');
                nameEl.className = 'mb-0';
                nameEl.textContent = record.customerName; // XSS Safe

                const cnicEl = document.createElement('small');
                cnicEl.className = 'text-muted';
                cnicEl.textContent = record.cnic; // XSS Safe

                const accountEl = document.createElement('small');
                accountEl.className = 'text-muted';
                accountEl.textContent = `A/C: ${record.accountNo}`; // XSS Safe

                infoDiv.append(nameEl, cnicEl, document.createElement('br'), accountEl);
                customerInfo.append(img, infoDiv);

                // ... (create and append balance elements similarly)

                item.appendChild(customerInfo);
                recordsContainer.appendChild(item);
            });
        }

        // Initial load
        loadAllRecords();
    });
    </script>
</body>
</html>    put in it      <script type="module">
  // Import Firebase from CDN (for static GitHub Pages)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-analytics.js";

  // ✅ Your Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyChqEOhLWphDoKnpqxImxw8LDxdLI5JfYA",
    authDomain: "digiledger-ea7c9.firebaseapp.com",
    projectId: "digiledger-ea7c9",
    storageBucket: "digiledger-ea7c9.firebasestorage.app",
    messagingSenderId: "357053207796",
    appId: "1:357053207796:web:cb8acb1efe2d563b4b3aa1",
    measurementId: "G-B1V9HLD2CE"
  };

  // ✅ Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app);

  // ✅ Example: Add a Ledger Entry
  async function addLedgerEntry(entry) {
    await addDoc(collection(db, "ledger"), entry);
    console.log("Entry added:", entry);
  }

  // ✅ Example: Get All Ledger Entries
  async function getLedgerEntries() {
    const querySnapshot = await getDocs(collection(db, "ledger"));
    querySnapshot.forEach((doc) => {
      console.log(doc.id, "=>", doc.data());
    });
  }

  // Test when page loads
  window.onload = async () => {
    await addLedgerEntry({ item: "Test Item", amount: 500, date: new Date().toISOString() });
    await getLedgerEntries();
  };
</script>
